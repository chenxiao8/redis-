**旧版复制**

当客户端向主服务器发送slaveOf命令以后，从服务器向主服务器发送SYNC命令，主服务收到后，执行BGSAVE命令生成RDB文件，并且将这期间执行的命令加载到缓冲区中。当RDB文件生成后主服务器将该RDB文件发送给从服务器，从服务器执行该RDB文件完成后执行主服务器缓冲区中的命令。完成同步，之后主服务器执行任何命令都会传播给从服务器，从服务器也会执行该命令。这样实现了主从复制。

缺陷：当命令传播以后，若从服务器断线，那么重新连接后又会执行一次SYNC命令，又需要主服务器生成完整的RDB文件并且传播，效率过低。

**新版复制：**

PSYNC ：其余步骤与SYNC命令一致，从服务器断线后执行部分重同步，主服务器只发送从服务器在断线期间的命令给从服务器，从服务器执行。而不需要执行整个RDB文件。

实现：

复制偏移量

复制积压缓冲区

服务器运行ID



**复制偏移量：**

主服务器与从服务器有一个复制偏移量offset，当主服务器向从服务器传播n个字节的数据后，从服务器的复制偏移量就会增加n，从服务器通过检查复制偏移量与主服务器是否相等来判断主从是否一致。

复制积压缓冲区：

是一个FIFO先入先出队列，它有一个长度，默认是1MB

当主服务器对从服务器命令传播时，它不仅会传播命令给从服务器，还会将命令存放进复制积压缓冲区。复制积压缓冲区中的每一个字节都会有一个复制偏移量offset，当从服务器执行PSYNC命令时会发送自己的offset，主服务器会判断该offset之后的数据是否在复制积压缓冲区中，如果在那么就返回从服务器一个+cotinue状态，并且将复制积压缓冲区的内容发送给从服务器。

复制积压缓冲区的大小可以调整：至少要调整为从服务器平均断线后连上的秒数 * 服务器每秒的写的数据大小

最好把他设置为该大小的两倍。



**复制的实现**



1.slaveof <master_ip> <master_port>

客户端发送请求后，从服务器将masterip和port保存在自己的服务器状态中



2.建立socket

从服务器与主服务器之间会建立一条socket连接，主服务器会为该socket管理一个文件事件处理器，专门处理之后的RDB文件传输操作，同时，主服务器会将从服务器视为一个客户端。

3.发送ping命令

从服务器会向主服务器发送一个ping命令，如果主服务器无法正常回应pong命令，那么从服务器就会断开socket并且尝试重新连接。

4.身份验证

如果主从服务器都设置了密码并且密码相同或者都未设置密码，那么就可以进行复制。否则断开。

5.从服务器向主服务器发送自己的监听端口号

6.发送PSYNC命令。此时主服务器也变成了从服务器的客户端

7.进入命令转播阶段



**心跳检测机制**

从服务器会以默认每秒一次的频率向客户端发送 REPLCONF ACK <offset> 命令

如果主服务器检测到offset与自己的offset不一致，那么就会从复制积压缓冲区中发送数据给从服务器。 检测命令丢失。

这个命令也可以用来定时检测网络连接问题。